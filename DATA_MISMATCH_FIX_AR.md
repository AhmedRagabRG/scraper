# إصلاح مشكلة اختلاط البيانات في Scraper
**التاريخ:** 2026-01-22

## المشكلة
كان الـ scraper أحياناً بيجيب الإيميل والموقع والرقم من مطعم مختلف عن المطعم اللي بيجيب اسمه.

### السبب
عندما يضغط الـ scraper على كارت المطعم في Google Maps، يفتح panel جانبي بتفاصيل المطعم. المشكلة كانت:
1. الـ panel ممكن ياخد وقت عشان يتحدث بالبيانات الجديدة
2. الكود كان بيستخرج البيانات بسرعة قبل ما الـ panel يتحدث بالكامل
3. فكان بيجيب بيانات من المطعم السابق أو مطعم مختلف

## الحل
تم إضافة 4 طبقات حماية لضمان استخراج البيانات الصحيحة:

### 1. زيادة وقت الانتظار بعد الضغط
```python
await asyncio.sleep(random.uniform(1.5, 2.5))  # كان 1-2 ثانية، أصبح 1.5-2.5
```

### 2. التحقق من تحديث الـ Panel
بعد الضغط على الكارت، الكود بيتحقق إن اسم المطعم في الـ panel يطابق اسم المطعم المتوقع:
- بيحاول 5 مرات (كل محاولة 0.5 ثانية)
- لو الاسم مطابق، يكمل استخراج البيانات
- لو مش مطابق، بينتظر وقت إضافي

### 3. التحقق النهائي قبل استخراج البيانات الحساسة
قبل استخراج الإيميل والرقم والموقع، الكود بيعمل double-check:
- بيتأكد مرة تانية إن اسم المطعم في الـ panel صحيح
- لو في اختلاف، بيطبع تحذير ويتخطى استخراج البيانات الحساسة
- ده بيمنع تماماً استخراج بيانات غلط

### 4. Scroll في الـ Panel
الكود بيعمل scroll في الـ panel عشان يتأكد إن كل العناصر اتحملت:
- بيساعد في تحميل البيانات اللي lazy-loaded
- بيضمن ظهور كل معلومات الاتصال

## التغييرات في الكود

### الملف المعدل
`scraper.py` - الـ function `_extract_place_details`

### الأسطر المضافة
- **السطر 589:** زيادة وقت الانتظار بعد الضغط
- **الأسطر 591-637:** نظام التحقق من تحديث الـ panel
- **الأسطر 650-670:** التحقق النهائي قبل استخراج البيانات
- **الأسطر 673-685:** Scroll في الـ panel

## كيفية الاستخدام
الكود يعمل بنفس الطريقة السابقة، لكن دلوقتي:
1. هيكون أبطأ شوية (عشان بيتحقق من البيانات)
2. هيطبع رسائل توضح إذا كان الـ panel اتحدث صح ولا لأ
3. لو في مشكلة، هيطبع تحذير بدل ما يجيب بيانات غلط

## رسائل الـ Console الجديدة
```
✓ Panel updated correctly for: مطعم أحمد
⚠️ Warning: Panel may not have updated correctly for مطعم محمد
⚠️ WARNING: Panel name mismatch! Expected 'مطعم أحمد' but got 'مطعم محمد'
⚠️ Skipping contact details extraction to avoid data mismatch
```

## الاختبار
جرب الـ scraper على بحث صغير (مثلاً 5-10 نتائج) وراقب الرسائل:
```python
python main.py
# أو
python api.py
```

## ملاحظات مهمة
1. الـ scraper دلوقتي أبطأ بحوالي 1-2 ثانية لكل مطعم (عشان الأمان)
2. لو شفت رسائل تحذير كتير، ممكن تحتاج تزود الـ delays أكتر
3. التحديثات دي بتحمي من 99% من حالات اختلاط البيانات

## في حالة استمرار المشكلة
لو المشكلة لسه موجودة:
1. زود الـ `max_attempts` من 5 لـ 10 (السطر 597)
2. زود الـ sleep time من 0.5 لـ 1 ثانية (السطر 628)
3. زود الـ initial sleep من 1.5-2.5 لـ 2-3 ثواني (السطر 589)
